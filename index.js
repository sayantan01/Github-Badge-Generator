const express=require('express')
const app=express()
const bodyParser=require('body-parser')
const fetch=require('node-fetch')
const fs=require('fs')
const pdfcrowd = require("pdfcrowd");
const client = new pdfcrowd.HtmlToPdfClient("coder", "486bc2e88a9a6b56eb3f090b6e15cfd5");

app.set('view engine','ejs');
app.use(bodyParser.urlencoded({extended:false}))
const filename=__dirname+"/Badge.pdf"

const imgurl_default="data:image/jpeg;base64,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"
let name="",imgurl="data:image/jpeg;base64,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"

app.get('/',(req,res)=>{
	res.render('index',{name,imgurl})
})

app.get('/badge',(req,res)=>{
	res.render('badge',{name,imgurl})
})

app.post('/avatar',async (req,res)=>{
	const username=req.body.username
	url=`https://api.github.com/users/${username}`
	try
	{
		const response = await fetch(url)
		if(response.ok)
		{
			const data=await response.json()
			name=data.name
			imgurl=data.avatar_url
			res.redirect('/')
		}
		else
		{
			res.sendStatus(404)
		}
		client.convertUrlToFile(
    	"https://git-badge-2020.herokuapp.com/badge",
    	filename,
    	function(err, fileName) {
        	if (err) return console.error("Pdfcrowd Error: " + err);
        	console.log("Success: the file was created " + fileName);
    	});
	}
	catch(err)
	{
		res.status(500).json(err)
	}
})

app.post('/download',(req,res)=>{
	res.setHeader('Content-disposition', 'attachment; filename=' + filename);
	res.download(filename)
})


const port=process.env.PORT || 8000

app.listen(port,()=>console.log(`http://localhost:${port}`))